# Claude Code 設定

## 言語設定
- 回答言語: 日本語
- すべての応答は日本語で行う

## 初期設定
このファイルはClaude Codeの初期設定を記録するためのものです。

## 問題修正時の必須プロトコル

### 修正後の動作確認ルール
問題を修正した際は、以下の手順を**必ず実施**すること：

1. **修正内容の実装**
   - コードやパラメータファイルを修正

2. **ビルド（必要な場合）**
   - `colcon build --packages-select <package_name> --symlink-install`
   - ビルドエラーがないことを確認

3. **動作確認テストの実施**
   - 修正したコンポーネントを実際に実行
   - エラーログがないことを確認
   - 期待される動作をしているか確認
   - 可能であれば自動テストスクリプトを作成して実行

4. **確認結果の報告**
   - テスト実行結果を提示
   - エラーがないことを証明
   - 期待される出力が得られていることを示す
   - 例：
     - ✅ ノードが正常起動
     - ✅ エラーログなし
     - ✅ トピックが正常に出力（XX Hzで確認）

5. **修正の完了報告**
   - 修正内容のまとめ
   - 動作確認結果
   - 実行方法の記載

### テスト方法の例

#### 単体テスト
```bash
# ノード単独起動テスト
ros2 run <package> <executable> --ros-args --params-file <yaml>

# タイムアウトで自動終了（エラーなく起動すればOK）
timeout 5 ros2 run <package> <executable>
```

#### 統合テスト
```bash
# launch起動テスト
ros2 launch <package> <launch_file>

# 別ターミナルで確認
ros2 node list | grep <node_name>
ros2 topic list | grep <topic_name>
ros2 topic hz <topic_name>
```

#### 自動テストスクリプト
```bash
#!/bin/bash
# バックグラウンドでlaunch起動
ros2 launch <package> <launch_file> &
LAUNCH_PID=$!

# 待機
sleep 5

# 確認
ros2 node list | grep <expected_node> && echo "✅ ノード起動成功" || echo "❌ ノード起動失敗"
ros2 topic hz <topic> --once && echo "✅ トピック出力確認" || echo "❌ トピック出力なし"

# クリーンアップ
kill $LAUNCH_PID
```

### 禁止事項
- ❌ 修正後にテストせずに「修正しました」と報告する
- ❌ 推測で「動作するはずです」と報告する
- ❌ エラーが残っているのに完了と報告する

### 推奨事項
- ✅ 実際の実行結果を提示する
- ✅ ログやtopic hzの出力を証拠として示す
- ✅ エラーが出ていないことを明示する
- ✅ テストスクリプトを作成して再現可能にする

---

# ロボットシステム仕様

## システム概要

### 起動コマンド
- **現行版（推奨）**: `ros2 launch bringup zed2i_nvblox_nav2_launch.py`
  - ZED2i + nvblox（3Dマッピング） + Nav2統合システム
  - **特徴**:
    - NVIDIA Isaac ROS nvbloxによる3Dマッピング（ESDF生成）
    - ZED2i Visual SLAMで自己位置推定（AMCLなし）
    - LiDAR統合による高精度マッピング
    - ZED ZUPT Filterによるオドメトリ安定化
    - ZED Body Trackingによるジェスチャー制御

- **旧版（非推奨）**: `ros2 launch bringup bringup_ps5_all_launch.py`
  - SLAM Toolbox使用版（2D SLAM）
  - **非推奨の理由**:
    - 2D SLAMのため環境認識能力が限定的
    - TF同期の複雑性（tf_sync_coordinator必要）
    - nvbloxに比べて精度が低い

### ハードウェア構成
- **プラットフォーム**: Jetson (Linux 5.15.148-tegra)
- **ロボットタイプ**: メカナムホイール移動ロボット
- **主要センサー**:
  - ZED2i ステレオカメラ（Visual SLAM、Body Tracking）
  - LiDAR x2（前後、障害物検出）
  - IMU（ZED2i内蔵）
- **制御方式**: PS5コントローラー (DualSense Wireless Controller)

## システムアーキテクチャ

### 実行中のノード数（zed2i_nvblox_nav2_launch.py使用時）
- **総ノード数**: 約40-50ノード（nvblox統合版）
- **総トピック数**: 約150-200トピック

### 主要ノード一覧

#### センサー・デバイス系
- **ZED2iカメラ** (zed_components/ZedCamera - Composable Node)
  - ステレオカメラ、IMU、Visual Odometry、Body Tracking
  - 複数の画像トピック、深度情報、ポイントクラウドを配信
  - 設定ファイル: `common_stereo_isaac.yaml`

- **LiDAR** (ldlidar_stl_ros2)
  - 前方LiDAR: `/front_scan`
  - 後方LiDAR: `/back_scan`
  - マージされたスキャン: `/merged_scan`
  - フィルタ後スキャン: `/merged_scan_filtered` → `/scan_filtered`

- **IMU** (ZED2i内蔵)
  - `/zed/zed_node/imu/data` - フィルタ済みIMUデータ
  - `/zed/zed_node/imu/data_raw` - 生IMUデータ
  - `/zed/zed_node/imu/mag` - 磁気センサー

#### 制御・通信系
- **micro_ros_agent**
  - マイコン通信用 (multiserial接続)
  - デバイス: `/dev/ttyACM1`, `/dev/ttyACM0`, `/dev/M5atom`
  - ボーレート: 1000000

- **joy_linux** (PS5コントローラー)
  - デバイス: `/dev/input/js0`
  - 更新レート: 30.0 Hz
  - デッドゾーン: 0.05

- **joy_mecanum_controller**
  - PS5入力をメカナム制御指令に変換
  - 出力: `/cmd_vel_teleop`

#### マッピング・ナビゲーション系（現行版）
- **nvblox_node** (NVIDIA Isaac ROS 3Dマッピング - Composable Node)
  - ESDF（Euclidean Signed Distance Field）生成
  - 拡張範囲: 14m（カスタム設定）
  - Occupancy Grid配信: `/map` (Nav2互換)
  - ポイントクラウド: `/nvblox_node/esdf_pointcloud`
  - メッシュ: `/nvblox_node/mesh`
  - マップスライス: `/nvblox_node/map_slice`
  - LiDAR統合: 有効

- **Navigation2スタック**
  - `controller_server` - 経路追従制御
  - `planner_server` - 経路計画
  - `behavior_server` - 行動制御
  - `bt_navigator` - Behavior Tree実行
  - `smoother_server` - 経路スムージング
  - `velocity_smoother` - 速度スムージング
  - `waypoint_follower` - ウェイポイント追従
  - **AMCLは不使用**（ZED Visual Odometry + nvbloxで自己位置推定）

- **Costmap2D**
  - `global_costmap` - nvblox ESDF点群 + LiDARスキャンから生成
  - `local_costmap` - ZEDポイントクラウド + LiDARスキャンから生成

#### 独自開発ノード（現行版）
- **zed_zupt_filter_node** (ZED ZUPT Filter)
  - オドメトリ暴走防止（Zero-velocity UPdaTe）
  - 出力: `/zed/zed_node/odom_zupt`
  - デバッグ: `/zupt/status`
  - 設定ファイル: `zed_zupt_params.yaml`

- **laser_merger2**
  - 前後LiDARスキャンのマージ
  - 出力: `/merged_scan`

- **zed_goal_publisher**
  - ZEDカメラベースのゴール配信（ジェスチャー制御）
  - Body Tracking利用
  - 出力: `/goal_pose`

- **safety_sensor**
  - 安全監視

#### 削除されたノード（旧版のみ）
- ~~**tf_sync_coordinator**~~ - TF-Topic同期（nvblox版では不要）
- ~~**slam_toolbox**~~ - 2D SLAM（nvbloxに置き換え）

## TFツリー構造

### 標準TFツリー（ZED2i + nvblox + Nav2統合）【2025-10-31更新版】

**重要**: このシステムでは以下のTFツリー構造を採用します。ZED2iが直接`map → odom`のTFを配信する構成です。

```
map (ZED2i map_frame、nvblox global frame)
 └─ odom (ZED2i odometry_frame、Visual Odometry親フレーム)
     └─ zed_camera_origin (ZED2i中間フレーム、Visual Odometryフレーム)
         └─ zed_camera_link (ZED2i base_frame、ロボット基準点)
             ├─ base_link (ロボット中心, static)
             ├─ front_lidar (前方LiDAR, static)
             ├─ back_lidar (後方LiDAR, static, -0.296m X, -0.03m Z, 180° pitch)
             ├─ target_person (人物追跡用, static)
             └─ zed_camera_center (カメラ中心, static)
                 ├─ zed_left_camera_frame (左カメラ, static)
                 │   └─ zed_left_camera_optical_frame (光学座標系, static)
                 └─ zed_right_camera_frame (右カメラ, static)
                     └─ zed_right_camera_optical_frame (光学座標系, static)
```

**重要な設計決定（2025-10-31更新）:**
- `map → odom`の接続はZED2iが動的TFで配信（`publish_map_tf: true`）
- ZED2iの`map_frame`パラメータは`'map'`を使用（Nav2標準命名）
- ZED2iの`odometry_frame`パラメータは`'odom'`を使用（Nav2標準命名）
- nvbloxは`global_frame: 'map'`でマップを配信するが、TFは配信しない

### TF配信責任とフレーム名の定義（2025-10-31更新版）

| TF変換 | 配信ノード | 説明 | 設定パラメータ |
|--------|-----------|------|---------------|
| `map` → `odom` | ZED2i (zed_node) | グローバルマップからオドメトリへの動的変換（Visual SLAM） | `map_frame: 'map'`<br>`odometry_frame: 'odom'`<br>`publish_map_tf: true` |
| `odom` → `zed_camera_origin` | ZED2i (zed_node) | オドメトリから中間フレームへの変換（Visual Odometry） | ZED内部で自動配信 |
| `zed_camera_origin` → `zed_camera_link` | ZED2i (zed_node) | 中間フレームからカメラリンクへの変換 | `base_frame: 'zed_camera_link'` |
| `zed_camera_link` → `base_link` | static_transform_publisher | カメラからロボット中心への変換 | `0.0 0.0 0.0 0.0 0.0 3.14159 zed_camera_link base_link` |
| `zed_camera_link` → `front_lidar` | static_transform_publisher | カメラから前方LiDARへの変換 | `0.0 0 -0.03 0 0 0 zed_camera_link front_lidar` |
| `zed_camera_link` → `back_lidar` | static_transform_publisher | カメラから後方LiDARへの変換 | `-0.296 0 -0.03 0 3.14159 0 zed_camera_link back_lidar` |

**注意: 旧版（static TF）との違い**
- 旧版: `map → odom`はstatic_transform_publisherで静的配信、ZED2iは`publish_map_tf: false`
- 現行版: `map → odom`はZED2iが動的配信、`publish_map_tf: true`

### TF配信レート（実測値）
- `map` → `odom`: **ZED内部レート** (~30 Hz、Visual SLAM、動的TF)
- `odom` → `zed_camera_origin`: **ZED内部レート** (~30 Hz、Visual Odometry)
- `zed_camera_origin` → `zed_camera_link`: **ZED内部レート** (~30 Hz)
- 静的TF: 10000 Hz (static_transform_publisher)

### フレーム名の役割（2025-10-31更新版）

- **`map`**: nvbloxとZED2iが共有するグローバル座標系（世界基準、3Dマッピング用）
- **`odom`**: ZED Visual Odometryの親フレーム（ZED2iが`map → odom`のTFを動的配信）
- **`zed_camera_origin`**: ZED内部の中間フレーム（Visual Odometry基準点）
- **`zed_camera_link`**: ZEDカメラの物理的取り付け位置（ロボット基準点）
- **`base_link`**: ロボットの幾何中心（制御基準点）
- **`front_lidar` / `back_lidar`**: 各LiDARセンサーの位置

**フレーム命名の重要な注意（2025-10-31更新）:**
- ZED2iの`map_frame`パラメータには`'map'`を指定（Nav2標準命名）
- ZED2iの`odometry_frame`パラメータには`'odom'`を指定（Nav2標準命名）
- これはROS2標準の命名規則に準拠し、Nav2とnvbloxとの互換性を確保するため
- ZED2iが`map → odom`のTFを動的に配信することで、Visual SLAMの位置推定を反映

### Nav2統合時のフレーム設定（2025-10-31更新版）

**重要**: 現行版では**AMCLは使用しません**。自己位置推定はZED Visual Odometry + nvbloxで実現します。

#### ~~AMCL（自己位置推定）~~ - 不使用
現行版では削除されています。ZED2iが`map → odom`のTFを動的に配信するため、AMCLは不要です。

#### Local Costmap（局所コストマップ）
```yaml
local_costmap:
  local_costmap:
    ros__parameters:
      global_frame: odom                 # オドメトリ基準で動的更新（標準命名）
      robot_base_frame: zed_camera_link  # ロボット基準
```

#### Global Costmap（大域コストマップ）
```yaml
global_costmap:
  global_costmap:
    ros__parameters:
      global_frame: map                  # マップ基準で静的
      robot_base_frame: zed_camera_link  # ロボット基準
```

#### Behavior Server（行動制御）
```yaml
behavior_server:
  ros__parameters:
    global_frame: odom                    # オドメトリ基準（標準命名）
    robot_base_frame: zed_camera_link     # ロボット基準
```

### nvblox統合時の注意事項【2025-10-31更新版】

**この設定で自律ナビゲーションが正常動作することを実機で確認済みです。**

1. **nvbloxの`global_frame`設定**: `map`を使用
   - nvbloxは`map`フレームでOccupancy Gridを配信（トピック: `/map`）
   - Global Costmapは`map`フレームで受信
   - nvblox自体はTFを配信しない

2. **ZED2iの`publish_map_tf`設定**: `true`に設定（重要、旧版から変更）
   - ZED2iが`map → odom`のTFを動的に配信
   - Visual SLAMの位置推定を反映
   - 理由: ZED2iのVisual SLAMで自己位置推定を実現するため

3. **ZED2iの`map_frame`パラメータ**: `'map'`を使用（旧版から変更）
   - ROS2標準の命名規則に準拠
   - Nav2とnvbloxとの互換性を確保
   - **これが最も重要な設定**

4. **ZED2iの`odometry_frame`パラメータ**: `'odom'`を使用
   - Nav2標準命名規則に準拠
   - `map → odom`のTF変換をZED2iが動的に配信

5. **static_transform_publisherは不使用**（旧版から変更）
   - `map → odom`のTFはZED2iが動的に配信
   - 旧版の静的TF配信は削除されました

6. **TFツリーの完全性確認が重要**
   - `map` → `odom` → `zed_camera_origin` → `zed_camera_link` が必須
   - ZED2iが`map → odom`を動的に配信していることを確認
   - どこかが欠けるとNav2が動作しない

7. **LiDAR統合**: 有効化（`use_lidar: true`）
   - nvbloxがLiDARスキャンを統合してマッピング精度を向上
   - トピック: `/scan_filtered`をリマップ

### TFツリー確認コマンド【2025-10-31更新版】

```bash
# TFツリー全体を可視化
ros2 run tf2_tools view_frames
# 生成されたframes.pdfで以下のTFツリーを確認:
# map -> odom -> zed_camera_origin -> zed_camera_link -> base_link

# 特定の座標変換を確認（map -> zed_camera_link）
ros2 run tf2_ros tf2_echo map zed_camera_link
# エラーなく座標変換が表示されればOK

# ZED2iのTF設定を確認（期待値も記載、2025-10-31更新）
ros2 param get /zed/zed_node pos_tracking.map_frame
# 期待値: map（旧版: odom）

ros2 param get /zed/zed_node pos_tracking.odometry_frame
# 期待値: odom（旧版: zed_camera_origin）

ros2 param get /zed/zed_node pos_tracking.base_frame
# 期待値: zed_camera_link

ros2 param get /zed/zed_node pos_tracking.publish_map_tf
# 期待値: true（旧版: false）

# 動的TFの確認（map -> odomはZED2iが配信）
ros2 topic echo /tf | grep -A 10 "map.*odom"
# map -> odom のTFが動的に配信されていることを確認
# 静的TFではなく、動的TFであることに注意

# nvbloxのマップ配信確認
ros2 topic echo /map --once
# Occupancy Gridが配信されていることを確認
```

## 主要トピック仕様（2025-10-31更新版）

### センサートピック

#### LiDAR
- `/front_scan` - 前方LiDAR生データ
  - 型: `sensor_msgs/msg/LaserScan`
- `/back_scan` - 後方LiDAR生データ
  - 型: `sensor_msgs/msg/LaserScan`
- `/merged_scan` - マージされたスキャン
  - 型: `sensor_msgs/msg/LaserScan`
  - QoS: RELIABLE, TRANSIENT_LOCAL
  - Publisher: `laser_merger2`
- `/merged_scan_filtered` または `/scan_filtered` - フィルタ後スキャン (ロボット本体除去)
  - 型: `sensor_msgs/msg/LaserScan`
  - nvbloxとNav2に入力

#### オドメトリ
- `/zed/zed_node/odom` - ZED Visual Odometry (生データ)
  - 型: `nav_msgs/msg/Odometry`
- `/zed/zed_node/odom_zupt` - ZED ZUPT Filter適用後オドメトリ
  - 型: `nav_msgs/msg/Odometry`
  - オドメトリ暴走防止
- `/zed/zed_node/pose` - ZED Pose (nvbloxに入力)
  - 型: `geometry_msgs/msg/PoseStamped`

#### IMU
- `/zed/zed_node/imu/data` - フィルタ済みIMU
  - 型: `sensor_msgs/msg/Imu`
- `/zed/zed_node/imu/data_raw` - 生IMU
  - 型: `sensor_msgs/msg/Imu`
- `/zed/zed_node/imu/mag` - 磁気センサー
  - 型: `sensor_msgs/msg/MagneticField`

#### カメラ（ZED2i）
- `/zed/zed_node/rgb/image_rect_color` - RGB画像（nvbloxに入力）
  - 型: `sensor_msgs/msg/Image`
- `/zed/zed_node/rgb/camera_info` - RGBカメラ情報（nvbloxに入力）
  - 型: `sensor_msgs/msg/CameraInfo`
- `/zed/zed_node/depth/depth_registered` - 深度画像（nvbloxに入力）
  - 型: `sensor_msgs/msg/Image`
- `/zed/zed_node/depth/camera_info` - 深度カメラ情報（nvbloxに入力）
  - 型: `sensor_msgs/msg/CameraInfo`
- `/zed/zed_node/point_cloud/cloud_registered` - ポイントクラウド
  - 型: `sensor_msgs/msg/PointCloud2`

#### Body Tracking（ZED2i）
- `/zed/zed_node/body_trk/skeletons` - 人体骨格検出
  - 型: `zed_interfaces/msg/ObjectsStamped`
  - ZED Goal Publisherで使用

### 制御トピック

#### 速度指令
- `/cmd_vel` - 統合速度指令
  - 型: `geometry_msgs/msg/Twist`
  - QoS: RELIABLE, VOLATILE
  - Publishers:
    - `velocity_smoother` (Nav2経由)
    - `behavior_server` (緊急動作)
    - `zed_goal_publisher`
  - Subscribers:
    - `joy_mecanum_controller` (メカナム制御へ変換)
    - `cmd_vel_float_changer` (可視化用)

- `/cmd_vel_teleop` - テレオペ指令
- `/cmd_vel_nav` - ナビゲーション指令
- `/mecanum/cmd_vel` - メカナム変換後指令

#### ゴール・ナビゲーション
- `/goal_pose` - ゴール位置
  - 型: `geometry_msgs/msg/PoseStamped`
- `/initialpose` - 初期位置設定

### マップ・3Dマッピング（nvblox）
- `/map` - nvblox Occupancy Grid（Nav2互換）
  - 型: `nav_msgs/msg/OccupancyGrid`
  - QoS: RELIABLE, TRANSIENT_LOCAL
  - Publisher: `nvblox_node`
  - リマップ元: `/nvblox_node/static_occupancy_grid`
- `/nvblox_node/mesh` - 3Dメッシュ
  - 型: `nvblox_msgs/msg/Mesh`
- `/nvblox_node/map_slice` - マップスライス（2D可視化用、14m範囲）
  - 型: `nvblox_msgs/msg/DistanceMapSlice`
- `/nvblox_node/esdf_pointcloud` - ESDF点群（コストマップソース）
  - 型: `sensor_msgs/msg/PointCloud2`
  - Global Costmapで使用
- `/nvblox_node/pointcloud` - 統合3D点群
  - 型: `sensor_msgs/msg/PointCloud2`

### ナビゲーション（Nav2）
- `/goal_pose` - ナビゲーションゴール
  - 型: `geometry_msgs/msg/PoseStamped`
  - ZED Goal PublisherまたはRViz2から配信
- `/plan` - グローバルプラン
  - 型: `nav_msgs/msg/Path`
- `/plan_smoothed` - スムージング後プラン
  - 型: `nav_msgs/msg/Path`
- `/transformed_global_plan` - 変換後グローバルプラン
  - 型: `nav_msgs/msg/Path`
- `/local_costmap/costmap` - 局所コストマップ
  - 型: `nav_msgs/msg/OccupancyGrid`
- `/global_costmap/costmap` - 大域コストマップ
  - 型: `nav_msgs/msg/OccupancyGrid`

### デバッグ・ステータス
- `/zupt/status` - ZUPT Filter状態
  - ZED ZUPT Filterのデバッグ情報

### ジョイスティック
- `/joy` - PS5コントローラー入力
  - 型: `sensor_msgs/msg/Joy`
  - 更新レート: 30 Hz

## 座標系設計（2025-10-31更新版）

### フレーム配置
- **map**: nvbloxとZED2iが共有するグローバル座標系
- **odom**: ZED Visual Odometryの親フレーム
- **zed_camera_origin**: ZED内部中間フレーム（Visual Odometry基準点）
- **zed_camera_link**: ZEDカメラ基準 (メインフレーム、ロボット基準点)
- **base_link**: ロボット基準 (zed_camera_linkから 0.0m X, 0.0m Y, 0.0m Z, 180° yaw)
- **front_lidar**: 前方LiDAR (zed_camera_linkから 0.0m X, 0.0m Y, -0.03m Z)
- **back_lidar**: 後方LiDAR (zed_camera_linkから -0.296m X, 0.0m Y, -0.03m Z, 180° pitch)

### 座標系の親子関係
1. `map` (nvblox + ZED Visual SLAM): 大域座標系
2. `odom` (ZED Visual Odometry): ロボット移動追跡
3. `zed_camera_origin` (ZED内部): 中間フレーム
4. `zed_camera_link` (ZED): センサー基準、ロボット基準点
5. `base_link`: ロボット中心

## システム特性（2025-10-31更新版）

### 時刻同期
- **旧版**: tf_sync_coordinator により TF ↔ Topic の時刻同期を実現
- **現行版**: ZED2iとnvbloxが直接連携するため、tf_sync_coordinatorは不要

### データフロー（現行版）
1. **センサー取得**: ZED2i (VO + IMU + RGB + Depth), LiDAR前後
2. **オドメトリ安定化**: ZED ZUPT Filter → `/zed/zed_node/odom_zupt`
3. **スキャンマージ**: laser_merger2 → `/merged_scan`
4. **フィルタリング**: laser_filters (ロボット本体除去) → `/scan_filtered`
5. **3Dマッピング**: nvblox (RGB + Depth + LiDAR → ESDF + Occupancy Grid)
6. **マップ配信**: nvblox → `/map` (Nav2互換)
7. **ナビゲーション**: Nav2 (プランニング → 制御)
8. **速度スムージング**: velocity_smoother
9. **メカナム変換**: joy_mecanum_controller
10. **実機制御**: micro_ros_agent → マイコン

### QoS設定

#### RELIABLE + TRANSIENT_LOCAL
- `/scan_filtered` (SLAM用スキャン保持)
- `/map` (マップデータ保持)

#### RELIABLE + VOLATILE
- `/cmd_vel` (速度指令)
- その他制御トピック

#### BEST_EFFORT + VOLATILE
- センサー生データ (高頻度更新)

## 起動シーケンス（2025-10-31更新版）

### Launch構造（現行版）
```
zed2i_nvblox_nav2_launch.py (メイン)
├─ zed2i_nvblox_fixed.launch.py (センサー・nvblox統合)
│  ├─ Component Container (nvblox_container)
│  ├─ Robot State Publisher (ZED URDF)
│  ├─ ZED Camera Node (Composable Node, 2秒後ロード)
│  │  - 設定: common_stereo_isaac.yaml
│  │  - publish_map_tf: true
│  │  - map_frame: 'map'
│  │  - odometry_frame: 'odom'
│  ├─ back_stl27l.launch.py (後方LiDAR)
│  ├─ stl27l.launch.py (前方LiDAR)
│  ├─ laser_merger.launch.py
│  ├─ box_filter_example.launch.py
│  ├─ micro_ros_agent (ノード)
│  ├─ joy_linux (ノード)
│  ├─ joy_mecanum_controller (ノード)
│  ├─ safety_sensor (ノード)
│  ├─ static_transform_publishers (base_link, LiDAR配置)
│  │  - map → odom は不使用（ZED2iが配信）
│  │  - zed_camera_link → base_link
│  │  - zed_camera_link → front_lidar
│  │  - zed_camera_link → back_lidar
│  ├─ ZED ZUPT Filter (3秒後起動)
│  ├─ nvblox Node (Composable Node, 4秒後ロード)
│  │  - 設定: nvblox_base.yaml, nvblox_zed.yaml
│  │  - 拡張設定: nvblox_extended_range.yaml (14m)
│  │  - Nav2統合: nvblox_nav2_integration.yaml
│  │  - use_lidar: true
│  ├─ ZED Goal Publisher (5秒後起動)
│  └─ RViz2 (オプション、6秒後起動)
└─ my_navigation_launch.py (Nav2、8秒後起動)
   - AMCLは不使用
   - 設定: my_nav2_params_mppi1.yaml
```

### Launch構造（旧版・非推奨）
```
bringup_ps5_all_launch.py (メイン)
├─ bringup_ps5_jetson_launch.py
│  └─ bringup_ps5_devices.launch.py + zed_camera.launch.py
├─ online_async_launch.py (SLAM Toolbox)
├─ my_navigation_launch.py (Nav2)
├─ zed_goal_publisher (ノード)
└─ tf_sync_coordinator (ノード)
```

### 必須パラメータファイル（現行版）
- **ZED2i**: `common_stereo_isaac.yaml`, `zed2i.yaml`
- **nvblox**: `nvblox_base.yaml`, `nvblox_zed.yaml`, `nvblox_extended_range.yaml`, `nvblox_nav2_integration.yaml`
- **Navigation**: `my_nav2_params_mppi1.yaml` (my_navigation_launch.py内で指定)
- **ZED ZUPT Filter**: `zed_zupt_params.yaml`
- **ZED Goal Publisher**: `zed_goal_publisher.yaml`

### 起動タイミング（重要）
1. **0秒**: Component Container, Robot State Publisher, デバイスノード起動
2. **2秒**: ZED Camera Node ロード
3. **3秒**: ZED ZUPT Filter 起動
4. **4秒**: nvblox Node ロード
5. **5秒**: ZED Goal Publisher 起動
6. **6秒**: RViz2 起動（オプション）
7. **8秒**: Nav2スタック起動

この起動順序により、ZED2iとnvbloxが完全に初期化された後にNav2が起動します。

## デバッグ・確認コマンド（2025-10-31更新版）

```bash
# ノード確認
ros2 node list
ros2 node list | grep -E "nvblox|zed|controller|planner"

# トピック確認
ros2 topic list
ros2 topic hz /merged_scan_filtered
ros2 topic hz /scan_filtered
ros2 topic hz /nvblox_node/esdf_pointcloud
ros2 topic hz /map
ros2 topic echo /cmd_vel

# TF確認（重要: ZED2iがmap→odomを動的配信）
ros2 run tf2_tools view_frames
ros2 run tf2_ros tf2_echo map zed_camera_link
ros2 run tf2_ros tf2_echo map odom
ros2 topic echo /tf | grep -A 10 "map.*odom"  # 動的TF確認

# ノード情報
ros2 node info /nvblox_node
ros2 node info /controller_server
ros2 node info /zed/zed_node
ros2 node info /zed_zupt_filter_node

# トピック詳細
ros2 topic info /map -v
ros2 topic info /nvblox_node/esdf_pointcloud -v

# パラメータ確認
ros2 param get /zed/zed_node pos_tracking.publish_map_tf
ros2 param get /zed/zed_node pos_tracking.map_frame
ros2 param get /zed/zed_node pos_tracking.odometry_frame
ros2 param get /nvblox_node global_frame
ros2 param get /nvblox_node use_lidar

# nvblox設定確認
ros2 param get /nvblox_node map_clearing_radius_m
ros2 param get /nvblox_node esdf_2d_max_height
ros2 param get /nvblox_node esdf_2d_min_height

# ZUPT Filter確認
ros2 topic echo /zupt/status
ros2 topic hz /zed/zed_node/odom_zupt
```

## 既知の課題・注意点（2025-10-31更新版）

1. **同名ノードの警告**:
   ```
   WARNING: Be aware that are nodes in the graph that share an exact name
   ```
   複数のtransform_listener_implノードが同名で起動している（無害）

2. **センサー高さ統一の重要性**:
   - 前後LiDARの高さ(-0.03m Z)を一致させることでマッピングの安定性を確保

3. **TF更新レート**:
   - Visual Odometry: ~30 Hz
   - ZED map→odom TF: ~30 Hz（動的TF）
   - nvblox更新: 設定による
   - ~~旧版: tf_sync_coordinator が必須~~ → 現行版では不要

4. **ZED2iのTF設定の重要性**:
   - `publish_map_tf: true` が必須（旧版: false）
   - `map_frame: 'map'` が必須（旧版: 'odom'）
   - `odometry_frame: 'odom'` が必須（旧版: 'zed_camera_origin'）
   - この設定を間違えるとNav2が動作しない

5. **LiDAR物理的取り付けの確認（重要）**:
   - ⚠️ **地図生成の前に必ず確認すべき項目**
   - **症状**: SLAMで地図がうまく生成できない、壁面を認識しない
   - **原因**: LiDARが下向きに傾いており、地面に向かって照射されている
   - **確認方法**:
     ```bash
     # RViz2でLiDARスキャンを可視化
     rviz2
     # LaserScanトピック (/front_scan, /back_scan, /merged_scan) を追加
     # 点群が水平に壁面を捉えているか確認
     # 地面のノイズが多い場合は下向き傾斜の可能性
     ```
   - **対処法**:
     - LiDARの取り付け角度を物理的に調整し、水平にする
     - 点群が壁面の適切な高さ（床から20-30cm程度）を捉えるよう調整
     - 調整後、再度スキャンデータを確認
   - **備考**:
     - パラメータ調整では解決できない物理的問題
     - 気づきにくく、忘れやすい課題のため要注意
     - 定期的な動作確認で早期発見が重要

---

# SLAM パラメータ最適化履歴（旧版・SLAM Toolbox使用時）

**注意**: このセクションは旧版（`bringup_ps5_all_launch.py`）で使用していたSLAM Toolboxのパラメータ最適化履歴です。現行版（`zed2i_nvblox_nav2_launch.py`）ではnvbloxを使用するため、このセクションは参考情報として残しています。

## 2025-10-09: 旋回時の壁面湾曲問題の改善（SLAM Toolbox）

### 問題
ロボット旋回時に壁面のエッジが追従できず湾曲してしまい、きれいな地図が生成できない

### 原因分析
1. **角度分散ペナルティ不足** (`angle_variance_penalty: 1.0`)
   - 旋回時の角度推定の不確実性が適切にペナルティ化されていない

2. **角度解像度が粗い**
   - `coarse_angle_resolution: 0.0349` (約2度) → 旋回時の細かい角度変化を捉えられない
   - `fine_search_angle_offset: 0.00349` (約0.2度) → さらに細かくする余地あり

3. **旋回更新閾値が大きすぎる**
   - `minimum_travel_heading: 0.05` (約2.9度) → 旋回中の細かいポーズ更新がスキップされる

4. **スキャン関連付けが緩い**
   - `link_scan_maximum_distance: 1.5` → 旋回時に誤った関連付けが発生しやすい
   - `link_match_minimum_response_fine: 0.1` → 低すぎて誤マッチを許容

5. **相関探索の分解能不足**
   - `correlation_search_space_resolution: 0.01` → エッジ検出に不十分

### 実施した改善

#### 1. 角度精度の向上
```yaml
# 変更前 → 変更後
angle_variance_penalty: 1.0 → 2.0              # 旋回精度を優先
coarse_angle_resolution: 0.0349 → 0.0175      # 2度 → 1度
fine_search_angle_offset: 0.00349 → 0.00175  # 0.2度 → 0.1度
minimum_angle_penalty: 0.9 → 0.95             # より厳格なペナルティ
```

#### 2. 旋回更新頻度の向上
```yaml
# 変更前 → 変更後
minimum_travel_heading: 0.05 → 0.017   # 2.9度 → 1度
minimum_travel_distance: 0.05 → 0.03   # 5cm → 3cm
map_update_interval: 1.0 → 0.5          # マップ更新を2倍高速化
minimum_time_interval: 0.01 → 0.005    # 時間分解能を2倍向上
```

#### 3. スキャンマッチング精度向上
```yaml
# 変更前 → 変更後
link_scan_maximum_distance: 1.5 → 1.0              # より厳格な関連付け
link_match_minimum_response_fine: 0.1 → 0.15      # 誤マッチ抑制
loop_match_minimum_response_coarse: 0.35 → 0.40   # ループ閉じ精度向上
loop_match_minimum_response_fine: 0.45 → 0.50     # ループ閉じ精度向上
```

#### 4. 相関探索の高精度化
```yaml
# 変更前 → 変更後
correlation_search_space_resolution: 0.01 → 0.005  # エッジ検出精度2倍
correlation_search_space_smear_deviation: 0.1 → 0.05  # スミアリング低減
```

#### 5. 旋回特化パラメータの追加
```yaml
# 新規追加パラメータ
max_scan_range: 15.0                    # 信頼性の高い範囲に制限
angular_update_min_delta: 0.017         # ~1度の角度更新閾値
linear_update_min_delta: 0.02           # 2cmの並進更新閾値

# オドメトリ信頼度設定
translation_variance: 0.001             # ZED VOの並進を高信頼
rotation_variance: 0.005                # ZED VOの回転も信頼

# スキャンマッチング閾値
scan_matching_min_distance: 0.02        # 2cm以上の移動で実行
scan_matching_min_angle: 0.017          # 1度以上の回転で実行

# 特徴マッチング
use_feature_matching: true              # 特徴ベースマッチング有効化
feature_match_threshold: 0.8            # 高信頼度マッチのみ採用

# 時間的一貫性
use_velocity_smoothing: true            # 速度推定の平滑化
velocity_smoothing_window: 5            # 5スキャン窓で平滑化

# グラフ最適化頻度
optimization_skip_scans: 3              # 3スキャン毎に最適化
scan_buffer_size: 50 → 70               # バッファ増加で平滑化強化
```

### 期待される効果

1. **旋回時のエッジ追従性向上**
   - 1度単位の細かい角度変化を捉えられる
   - 壁面の直線性が保たれる

2. **マップ更新の即応性向上**
   - 0.5秒間隔でマップ更新 (従来の2倍)
   - 旋回中のリアルタイム性向上

3. **誤マッチの抑制**
   - より厳格なスキャン関連付け
   - エッジ検出精度の向上

4. **オドメトリとの協調**
   - ZED VO (16Hz) の回転情報を適切に活用
   - TF同期との整合性向上

### テスト方法

```bash
# 1. システム起動
ros2 launch bringup bringup_ps5_all_launch.py

# 2. RViz2で地図確認
rviz2 -d <config_file>

# 3. ロボットをその場で360度旋回させる
#    - ゆっくり旋回 (30秒/360度)
#    - 中速旋回 (15秒/360度)
#    - 高速旋回 (10秒/360度)

# 4. 壁面の直線性を確認
#    - 直線の壁が直線として表現されているか
#    - 角部分が明瞭に90度を保っているか
#    - 旋回前後で壁位置がズレていないか

# 5. SLAMログ確認
ros2 topic echo /slam_toolbox/feedback
```

### 注意事項

1. **計算負荷の増加**
   - より細かい角度探索により計算量が増加
   - Jetson環境でCPU使用率を監視

2. **パラメータ調整の可能性**
   - 実環境でのテストにより微調整が必要な場合あり
   - 特に `angle_variance_penalty` と `rotation_variance` のバランス

3. **バックアップ**
   - オリジナルファイル: `mapper_params_online_async copy.yaml` として保存推奨

---

# ビルドシステム設定とトラブルシューティング

## 環境変数設定（必須）

ROS2ワークスペースのビルド前に、以下の環境変数を設定する必要があります：

```bash
# Isaac ROSワークスペースのパスを設定
export ISAAC_ROS_WS=/home/jetros/ros2_ws

# Isaac ROSモデルのEULA承認（オプショナル、モデルパッケージをビルドする場合）
export ISAAC_ROS_ACCEPT_EULA=1

# CUDA環境変数（既存設定の確認）
export CUDA_HOME=/usr/local/cuda
export PATH=$CUDA_HOME/bin:$PATH
export CUDAARCHS=87
```

**✅ 完了済み:** `ISAAC_ROS_WS`は既に`~/.bashrc`で設定済みです。新しいターミナルセッションでは自動的に有効になります。

確認方法：
```bash
# 新しいターミナルを開いて確認
echo $ISAAC_ROS_WS
# 出力: /home/jetros/ros2_ws
```

## ビルドコマンド

### 基本ビルドコマンド

**推奨ビルドコマンド（オプショナルパッケージをスキップ）:**
```bash
cd /home/jetros/ros2_ws

# 通常のビルド（未完了パッケージのみ）
colcon build --packages-skip-build-finished --symlink-install \
  --packages-skip isaac_ros_ess_models_install \
                  isaac_ros_peoplenet_models_install \
                  isaac_ros_peoplesemseg_models_install \
                  isaac_ros_nova_recorder

# クリーンビルド（全パッケージ）
colcon build --symlink-install \
  --packages-skip isaac_ros_ess_models_install \
                  isaac_ros_peoplenet_models_install \
                  isaac_ros_peoplesemseg_models_install \
                  isaac_ros_nova_recorder
```

**その他の便利なコマンド:**
```bash
# 特定のパッケージのみビルド
colcon build --packages-select <package_name> --symlink-install

# 特定のパッケージとその依存関係をビルド
colcon build --packages-up-to <package_name> --symlink-install

# 特定のパッケージをスキップしてビルド
colcon build --packages-skip <package1> <package2> --symlink-install
```

**注意:** `ISAAC_ROS_WS`環境変数は`.bashrc`で自動設定されるため、手動でexportする必要はありません。

### オーバーライド設定付きビルド
一部のパッケージは既存のROS2インストールと競合する場合があります：

```bash
colcon build --packages-select <package_name> \
  --allow-overriding <package_name> \
  --symlink-install
```

## 既知のビルドエラーと解決方法

### 2025-10-14: ワークスペース全体のビルドエラー対応

このセクションでは、268パッケージ全てを正常にビルドするために必要だった対応をまとめます。

---

#### エラー1: rmw_microxrcedds - snprintf警告エラー

**症状:**
```
error: '__builtin_snprintf' output may be truncated before the last format character
```

**原因:**
- `rmw_microxrcedds_c/src/rmw_microros/init_options.c`で`snprintf`のバッファサイズチェックが不適切
- `-Werror`フラグにより警告がエラーとして扱われる

**解決方法:**

1. **バッファサイズチェックの修正**

[init_options.c:93](/home/jetros/ros2_ws/src/uros/rmw_microxrcedds/rmw_microxrcedds_c/src/rmw_microros/init_options.c#L93)
```c
// 修正前
if (ip != NULL && strlen(ip) <= MAX_IP_LEN) {

// 修正後（null終端を考慮）
if (ip != NULL && strlen(ip) < MAX_IP_LEN) {
```

2. **引数長チェックの追加**

[init_options.c:43-45](/home/jetros/ros2_ws/src/uros/rmw_microxrcedds/rmw_microxrcedds_c/src/rmw_microros/init_options.c#L43-L45)
```c
// 修正前
snprintf(rmw_options->impl->transport_params.agent_address, MAX_IP_LEN, "%s", argv[1]);
snprintf(rmw_options->impl->transport_params.agent_port, MAX_PORT_LEN, "%s", argv[2]);

// 修正後
if (strlen(argv[1]) < MAX_IP_LEN && strlen(argv[2]) < MAX_PORT_LEN) {
  snprintf(rmw_options->impl->transport_params.agent_address, MAX_IP_LEN, "%s", argv[1]);
  snprintf(rmw_options->impl->transport_params.agent_port, MAX_PORT_LEN, "%s", argv[2]);
} else {
  RMW_UROS_TRACE_MESSAGE("Agent IP or port argument too long.");
  ret = RMW_RET_INVALID_ARGUMENT;
}
```

3. **CMake警告設定の調整**

[CMakeLists.txt:344-345](/home/jetros/ros2_ws/src/uros/rmw_microxrcedds/rmw_microxrcedds_c/CMakeLists.txt#L344-L345)
```cmake
# 修正後
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -Werror -Wno-format-truncation")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Werror -Wno-format-truncation")
```

**ビルドコマンド:**
```bash
rm -rf build/rmw_microxrcedds install/rmw_microxrcedds
colcon build --packages-select rmw_microxrcedds --symlink-install
```

---

#### エラー2: nvblox_ros - サブモジュール未初期化

**症状:**
```
CMake Error: include could not find requested file:
  nvblox_core/cmake/cuda/setup_compute_capability.cmake

CMake Error: add_subdirectory source directory does not contain a CMakeLists.txt file.
  /home/jetros/ros2_ws/src/isaac_ros_nvblox/nvblox_ros/nvblox_core
```

**原因:**
- Gitサブモジュール`nvblox_core`が初期化されていない
- `nvblox_ros/nvblox_core`ディレクトリは存在するが中身が空

**解決方法:**

1. **サブモジュールの初期化**
```bash
cd /home/jetros/ros2_ws/src/isaac_ros_nvblox
git submodule update --init --recursive
```

2. **確認**
```bash
ls -la nvblox_ros/nvblox_core/
# CMakeLists.txt, README.md, cmake/ などが存在することを確認
```

3. **テストをスキップしてビルド**

テストビルド時に権限エラーが発生するため、テストをスキップします：
```bash
rm -rf build/nvblox_ros install/nvblox_ros
export ISAAC_ROS_WS=/home/jetros/ros2_ws
colcon build --packages-select nvblox_ros \
  --symlink-install \
  --cmake-args -DBUILD_TESTING=OFF
```

**ビルド時間:** 約6-10分（CUDAコンパイルのため）

**注意事項:**
- `nvblox_ros`は大規模パッケージでCUDAを使用するため、ビルドに時間がかかる
- Jetson環境では特にメモリ使用量に注意

---

#### エラー3: cartographer_ros_msgs, gazebo_msgs - シンボリックリンクエラー

**症状:**
```
failed to create symbolic link because existing path cannot be removed: Is a directory
gmake[2]: *** [CMakeFiles/ament_cmake_python_symlink_<package>.dir/build.make:70] エラー 1
```

**原因:**
- 以前のビルドで作成されたディレクトリがシンボリックリンク作成を妨げている
- `--symlink-install`オプション使用時の既知の問題

**解決方法:**

1. **ビルドキャッシュのクリア**
```bash
# 問題のあるパッケージのビルドキャッシュを削除
rm -rf build/cartographer_ros_msgs
rm -rf build/gazebo_msgs
rm -rf build/zed_topic_benchmark_interfaces
```

2. **再ビルド**
```bash
export ISAAC_ROS_WS=/home/jetros/ros2_ws
colcon build --packages-select cartographer_ros_msgs gazebo_msgs \
  --symlink-install \
  --allow-overriding cartographer_ros_msgs
```

**予防策:**
- クリーンビルドが必要な場合は、`build/`と`install/`ディレクトリを完全削除
- 問題が頻発する場合は`--symlink-install`なしでビルドを検討

---

#### エラー4: isaac_ros_argus_camera - 依存パッケージ不足

**症状:**
```
fatal error: camera_info_manager/camera_info_manager.hpp: そのようなファイルやディレクトリはありません
```

**原因:**
- ROS 2標準パッケージ`camera_info_manager`がシステムにインストールされていない
- `isaac_ros_argus_camera`のビルド依存関係

**解決方法:**

1. **依存パッケージのインストール**
```bash
sudo apt update
sudo apt install -y ros-humble-camera-info-manager
```

2. **ビルドキャッシュのクリアと再ビルド**
```bash
rm -rf build/isaac_ros_argus_camera
export ISAAC_ROS_WS=/home/jetros/ros2_ws
colcon build --packages-select isaac_ros_argus_camera --symlink-install
```

**追加の依存パッケージ:**
- `camera_info_manager` - カメラキャリブレーション情報管理
- `camera_calibration_parsers` - 自動的にインストールされる

---

#### エラー5: Isaac ROSモデルパッケージ - EULA未承認

**症状:**
```
ERROR: Please run the following command to view and accept the EULA before downloading
or set environment variable: ISAAC_ROS_ACCEPT_EULA=1
```

**対象パッケージ:**
- `isaac_ros_ess_models_install`
- `isaac_ros_peoplenet_models_install`
- `isaac_ros_peoplesemseg_models_install`

**原因:**
- NVIDIA Isaac ROSモデルのダウンロードにEULA承認が必要

**解決方法（オプション）:**

これらのパッケージは**オプショナル**です。必要な場合のみビルドしてください。

1. **EULA承認とビルド**
```bash
export ISAAC_ROS_ACCEPT_EULA=1
export ISAAC_ROS_WS=/home/jetros/ros2_ws
colcon build --packages-select \
  isaac_ros_ess_models_install \
  isaac_ros_peoplenet_models_install \
  isaac_ros_peoplesemseg_models_install \
  --symlink-install
```

2. **スキップしてビルド（推奨）**
```bash
export ISAAC_ROS_WS=/home/jetros/ros2_ws
colcon build --packages-skip-build-finished \
  --packages-skip \
    isaac_ros_ess_models_install \
    isaac_ros_peoplenet_models_install \
    isaac_ros_peoplesemseg_models_install \
  --symlink-install
```

**注意事項:**
- モデルファイルは数百MBのサイズがあり、ダウンロードに時間がかかる
- TensorRTエンジン生成にも時間がかかる（初回のみ）

---

#### エラー6: isaac_ros_hawk/owl - ヘッダーファイル不足

**症状:**
```
fatal error: isaac_ros_argus_camera/argus_camera_node.hpp: そのようなファイルやディレクトリはありません
```

**原因:**
- `isaac_ros_argus_camera`パッケージが存在しない、またはビルドされていない
- Isaac ROS Novaカメラ用の依存パッケージ

**解決方法:**

1. **isaac_ros_argus_cameraリポジトリの取得**
```bash
cd /home/jetros/ros2_ws/src
git clone https://github.com/NVIDIA-ISAAC-ROS/isaac_ros_argus_camera.git
```

2. **依存パッケージのインストール**
```bash
sudo apt install -y ros-humble-camera-info-manager
```

3. **ビルド順序の確保**
```bash
export ISAAC_ROS_WS=/home/jetros/ros2_ws

# 1. isaac_ros_argus_cameraを先にビルド
colcon build --packages-select isaac_ros_argus_camera --symlink-install

# 2. hawk/owlをビルド
rm -rf build/isaac_ros_hawk build/isaac_ros_owl
colcon build --packages-select isaac_ros_hawk isaac_ros_owl --symlink-install
```

---

## ビルド後の確認

### 全パッケージのビルド確認
```bash
# インストール済みパッケージ数を確認
ls install/ | wc -l
# 期待値: 268（または総パッケージ数）

# 特定のパッケージの確認
ls install/ | grep -E "nvblox_ros|isaac_ros_argus_camera"
```

### ビルド成功の確認
```bash
# ビルドログの確認
colcon build --packages-skip-build-finished --symlink-install 2>&1 | tail -20

# エラーがないことを確認
# "Summary: N packages finished" が表示されればOK
```

---

## トラブルシューティングチェックリスト

ビルドエラーが発生した場合、以下の順序で確認してください：

### 1. 環境変数の確認
```bash
echo $ISAAC_ROS_WS
echo $CUDA_HOME
echo $PATH | grep cuda
```

### 2. 依存パッケージの確認
```bash
# ROS 2パッケージ
apt list --installed | grep ros-humble

# システムパッケージ
dpkg -l | grep -E "cuda|tensorrt"
```

### 3. Gitサブモジュールの確認
```bash
# ワークスペース内の全サブモジュール確認
find src -name ".gitmodules" -exec cat {} \;

# サブモジュールの初期化状態確認
find src -type d -name ".git" | head -10
```

### 4. ビルドキャッシュのクリア
```bash
# 問題のあるパッケージのみクリア
rm -rf build/<package_name> install/<package_name>

# 全体をクリーンビルド（最終手段）
rm -rf build/ install/ log/
colcon build --symlink-install
```

### 5. ディスク容量の確認
```bash
df -h /home/jetros/ros2_ws
# 少なくとも10GB以上の空き容量が必要
```

---

## ビルド時の推奨設定

### メモリ不足対策（Jetson環境）
```bash
# 並列ビルド数を制限
colcon build --symlink-install --parallel-workers 2

# 特定の大規模パッケージは個別にビルド
colcon build --packages-select nvblox_ros --symlink-install
# その後、残りをビルド
colcon build --packages-skip-build-finished --symlink-install
```

### ビルド時間の最適化
```bash
# ccacheの使用（インストールされている場合）
export CC="ccache gcc"
export CXX="ccache g++"
colcon build --symlink-install

# 変更されたパッケージのみビルド
colcon build --packages-skip-build-finished --symlink-install
```

---

## よくある質問（FAQ）

### Q1: ビルドに何時間もかかる
**A:** 以下のパッケージは特に時間がかかります：
- `nvblox_ros`: 6-10分（CUDA）
- `nav2_mppi_controller`: 8-9分
- `nav2_smac_planner`: 7-10分
- `cartographer_ros`: 2-3分

初回ビルドでは全体で30分〜1時間程度かかることがあります。

### Q2: メモリ不足でビルドが失敗する
**A:** 並列ビルド数を制限：
```bash
colcon build --parallel-workers 2 --symlink-install
```

### Q3: シンボリックリンクエラーが頻発する
**A:** 以下を試してください：
```bash
# 1. ビルドキャッシュを完全削除
rm -rf build/ install/

# 2. symlink-installなしでビルド
colcon build

# 3. 問題のあるパッケージのみ個別にビルド
rm -rf build/<package_name>
colcon build --packages-select <package_name>
```

### Q4: CUDA関連エラーが出る
**A:** CUDA環境変数を確認：
```bash
export CUDA_HOME=/usr/local/cuda
export PATH=$CUDA_HOME/bin:$PATH
export CUDAARCHS=87  # Jetson Orin用
```

---

## 参考リンク

- [ROS 2 Humble Documentation](https://docs.ros.org/en/humble/)
- [colcon Documentation](https://colcon.readthedocs.io/)
- [Isaac ROS Documentation](https://nvidia-isaac-ros.github.io/)
- [CUDA Toolkit Documentation](https://docs.nvidia.com/cuda/)

---

## 更新履歴

- **2025-10-14**: 初版作成 - 268パッケージの完全ビルド手順を記録
- **2025-10-14**: rmw_microxrcedds snprintf警告修正を追加
- **2025-10-14**: nvblox_rosサブモジュール問題を追加
- **2025-10-14**: isaac_ros_argus_camera依存関係を追加
- **2025-10-17**: ワークスペース全体ビルド成功 - 279パッケージビルド完了
  - slam_toolboxシンボリックリンクエラー修正
  - オプショナルパッケージ（モデル4個）のスキップ設定確立
  - ISAAC_ROS_WS環境変数を.bashrcに追加
  - 推奨ビルドコマンドを簡素化