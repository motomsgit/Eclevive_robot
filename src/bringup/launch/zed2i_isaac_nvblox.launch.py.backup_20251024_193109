#!/usr/bin/env python3
"""
ZED2i Isaac ROS nvblox Integration Launch File

このlaunchファイルは、ZED2iカメラとNVIDIA Isaac ROS nvbloxを統合して起動します。
- ZED2iカメラドライバ（Isaac ROS互換設定）
- nvblox 3Dマッピング
- 可視化ツール（オプショナル）

使用方法:
  ros2 launch bringup zed2i_isaac_nvblox.launch.py
  ros2 launch bringup zed2i_isaac_nvblox.launch.py enable_visualization:=false
  ros2 launch bringup zed2i_isaac_nvblox.launch.py camera_name:=zed2i
"""

import os
import launch
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, LogInfo, IncludeLaunchDescription
from launch.substitutions import LaunchConfiguration, TextSubstitution
from launch.conditions import IfCondition, UnlessCondition
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch_ros.actions import Node, ComposableNodeContainer, LoadComposableNodes
from launch_ros.descriptions import ComposableNode
from ament_index_python.packages import get_package_share_directory


def generate_launch_description():
    """
    ZED2i + nvblox統合launchファイル
    """

    # Launch引数の定義
    camera_name_arg = DeclareLaunchArgument(
        'camera_name',
        default_value='zed',
        description='Name of the camera namespace'
    )

    camera_model_arg = DeclareLaunchArgument(
        'camera_model',
        default_value='zed2i',
        description='ZED camera model (zed2i fixed for Isaac ROS)'
    )

    enable_visualization_arg = DeclareLaunchArgument(
        'enable_visualization',
        default_value='true',
        description='Enable RViz2 visualization',
        choices=['true', 'false']
    )

    container_name_arg = DeclareLaunchArgument(
        'container_name',
        default_value='nvblox_container',
        description='Name of the component container for nvblox and ZED'
    )

    log_level_arg = DeclareLaunchArgument(
        'log_level',
        default_value='info',
        description='Logging level',
        choices=['debug', 'info', 'warn', 'error']
    )

    # Launch設定の取得
    camera_name = LaunchConfiguration('camera_name')
    camera_model = LaunchConfiguration('camera_model')
    enable_visualization = LaunchConfiguration('enable_visualization')
    container_name = LaunchConfiguration('container_name')
    log_level = LaunchConfiguration('log_level')

    # パッケージディレクトリの取得
    zed_wrapper_dir = get_package_share_directory('zed_wrapper')
    nvblox_examples_dir = get_package_share_directory('nvblox_examples_bringup')

    # コンポーネントコンテナの作成
    # nvbloxとZEDカメラを同じコンテナで実行（効率化のため）
    container = ComposableNodeContainer(
        name=container_name,
        namespace='',
        package='rclcpp_components',
        executable='component_container_mt',
        arguments=['--ros-args', '--log-level', log_level],
        output='screen',
        emulate_tty=True,
    )

    # ZED2i カメラドライバの起動（Isaac ROS互換設定）
    zed_camera_launch = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(zed_wrapper_dir, 'launch', 'zed2i_isaac_camera.launch.py')
        ),
        launch_arguments={
            'camera_name': camera_name,
            'camera_model': camera_model,
            'container_name': container_name,
            'publish_urdf': 'true',
            'publish_tf': 'true',
            'publish_map_tf': 'false',  # nvbloxがmap->odomを配信
            'publish_imu_tf': 'false',
        }.items()
    )

    # nvblox 3Dマッピングの起動
    nvblox_launch = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(nvblox_examples_dir, 'launch', 'perception', 'nvblox.launch.py')
        ),
        launch_arguments={
            'container_name': container_name,
            'mode': 'static',  # 静的環境マッピングモード
            'camera': 'zed2',  # nvblox内部でZED2設定を使用
        }.items()
    )

    # 可視化（オプショナル）
    visualization_launch = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(nvblox_examples_dir, 'launch', 'visualization', 'visualization.launch.py')
        ),
        launch_arguments={
            'mode': 'static',
            'camera': 'zed2',
        }.items(),
        condition=IfCondition(enable_visualization)
    )

    # ログ情報
    log_info_start = LogInfo(
        msg='========================================\n'
            'Starting ZED2i Isaac ROS nvblox Integration\n'
            '========================================\n'
            'Camera: ZED2i\n'
            'Container: nvblox_container\n'
            'nvblox mode: static\n'
            'Visualization: enabled (if enable_visualization:=true)\n'
            '========================================'
    )

    log_info_topics = LogInfo(
        msg='\nExpected Topics:\n'
            '  /zed/zed_node/rgb/image_rect_color\n'
            '  /zed/zed_node/depth/depth_registered\n'
            '  /zed/zed_node/pose\n'
            '  /nvblox_node/mesh\n'
            '  /nvblox_node/map_slice\n'
            '\nTF Frames:\n'
            '  map -> odom -> zed_camera_link -> base_link\n'
    )

    # LaunchDescriptionの構築
    return LaunchDescription([
        # 引数の宣言
        camera_name_arg,
        camera_model_arg,
        enable_visualization_arg,
        container_name_arg,
        log_level_arg,

        # ログ情報
        log_info_start,
        log_info_topics,

        # コンポーネントコンテナ
        container,

        # ZED2iカメラ起動
        zed_camera_launch,

        # nvbloxマッピング起動
        nvblox_launch,

        # 可視化（条件付き）
        visualization_launch,

        # 完了ログ
        LogInfo(
            msg='\n========================================\n'
                'ZED2i Isaac ROS nvblox launched successfully!\n'
                'Use RViz2 to visualize the 3D map.\n'
                '========================================'
        ),
    ])
